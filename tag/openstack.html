<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Damani blog - openstack</title>
        <link rel="stylesheet" href="https://damani42.github.io/theme/css/main.css" />
        <link href="https://damani42.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Damani blog Atom Feed" />
</head>

<body id="index" class="home">
<a href="https://github.com/damani42">
<img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" />
</a>
        <header id="banner" class="body">
                <h1><a href="https://damani42.github.io/">Damani blog</a></h1>
                <nav><ul>
                    <li><a href="https://damani42.github.io/pages/about.html">About</a></li>
                    <li><a href="https://damani42.github.io/category/misc.html">Misc</a></li>
                    <li><a href="https://damani42.github.io/category/openstack.html">OpenStack</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="https://damani42.github.io/presentation-of-ensure-tox-role.html">Presentation of ensure-tox role.</a></h1>
<footer class="post-info">
        <abbr class="published" title="2020-08-18T14:45:00+02:00">
                Published: Tue 18 August 2020
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://damani42.github.io/author/damani.html">Damani</a>
        </address>
<p>In <a href="https://damani42.github.io/category/openstack.html">OpenStack</a>.</p>
<p>tags: <a href="https://damani42.github.io/tag/python.html">python</a> <a href="https://damani42.github.io/tag/openstack.html">openstack</a> <a href="https://damani42.github.io/tag/zuul.html">zuul</a> <a href="https://damani42.github.io/tag/tox.html">tox</a> </p>
</footer><!-- /.post-info --><h1>Introduction</h1>
<p>The <a href="https://opendev.org/zuul/zuul-jobs/src/branch/master/roles/ensure-tox/README.rst">ensure-tox</a>
is simple. It's a ansible playbook for zuul to check if tox is install. It
looks for tox, and if it can't found it, it install it via pip into a virtual
environment for the current user. It can be very useful sometimes and
particulary with the usage of <code>ensure_global_symlinks</code> variable.</p>
<h1>Example with a bug fix</h1>
<p>Recently with a colleague <strong>Bernard Cafarelli</strong>, we've fixed the
<a href="https://review.opendev.org/#/c/745304/">upstream CI</a> for
<a href="https://github.com/openstack/oslo-cookiecutter">oslo-cookiecutter</a>. It
is a project that makes it easy to create an oslo project. The problem came
from a test script that tried to run the tox command in the newly created
project. The tox command was therefore not visible in the virtualenv created by
the new project. I could not reproduce the bug in local, because couldn't
immediately identify the problem because I had tox installed on my machine.
In such cases, ensure-tox comes in handy. With the use of the
<code>ensure_global_symlinks</code> variable which allows to make a symlink into
<code>/usr/local/bin</code> path. It is needed in this case, because the script
expects to have tox in a more standard location. The ensure-tox role was
already in use by the parent job. So we just had to add the use of the variable
to fix the bug.</p>
<h1>Zuul jobs</h1>
<p>The oslo-cookiecutter project uses <a href="https://opendev.org/zuul/zuul-jobs">zuul-jobs</a>.
It is a project that contains a set of Zuul jobs and Ansible roles suitable for
use by any Zuul system. This allows in one of his projects to be able to reuse
already existing job, role and not to reinvent the wheel. In our case,
oslo-cookiecutter uses the
<a href="https://zuul-ci.org/docs/zuul-jobs/python-jobs.html#job-tox">tox job</a> from the
zuul-jobs project. The tox job uses the ensure-tox role, as can be
<a href="https://opendev.org/zuul/zuul-jobs/src/branch/master/playbooks/tox/pre.yaml#L4">seen here</a>.
The tox playbook first performs the ensure-tox role. As explained previously,
ensure-tox makes sure that tox is installed. If it is not installed, the role
will install it in a virtualenv using the
<a href="https://opendev.org/zuul/zuul-jobs/src/branch/master/roles/ensure-tox/tasks/main.yaml#L21-L33">ensure-pip-virtualenv</a>
role. In our case, we had to use the <code>ensure_global_symlinks</code> variable. To
have the tox command accessible in a
<a href="https://opendev.org/zuul/zuul-jobs/src/branch/master/roles/ensure-tox/tasks/main.yaml#L38-L46">path</a>
of the <code>$PATH</code> which allowed us to correct our problem. The zuul-jobs project
contains many roles and playbooks. I will write an article soon to introduce
zuul and zuul-jobs.</p>
<h1>Conclusion</h1>
<p>In conclusion, ensure-tox is very useful to ensure that the job has tox
installed and to have a symlink on the host system for scripts that need it.
This is quite specific to OpenStack, because few projects use zuul. But if you
are using zuul for a python project. I recommend you to use zuul-jobs and
ensure-tox too. To enjoy a multitude of jobs, playbooks and ansible roles for
zuul already written.</p><p>There are <a href="https://damani42.github.io/presentation-of-ensure-tox-role.html#disqus_thread">comments</a>.</p>                </article>
            </aside><!-- /#featured -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="https://blog.cafarelli.fr/">Bernard Cafarelli</a></li>
                            <li><a href="https://herve.beraud.io">Herv√© Beraud</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="https://damani42.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://github.com/damani42">github</a></li>
                            <li><a href="https://twitter.com/damanired">twitter</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>. The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>.
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->

<script type="text/javascript">
    var disqus_shortname = 'damani-1';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>